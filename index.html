<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle&Guardians í€˜ìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            backdrop-filter: blur(10px);
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .quest-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-left: 4px solid #667eea;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        .quest-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateX(5px);
        }
        .quest-active {
            border-left-color: #10b981;
            background: linear-gradient(to right, #ecfdf5 0%, white 100%);
        }
        .quest-ended {
            border-left-color: #ef4444;
            background: linear-gradient(to right, #fef2f2 0%, white 100%);
        }
        .quest-upcoming {
            border-left-color: #f59e0b;
            background: linear-gradient(to right, #fffbeb 0%, white 100%);
        }
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-50" style="background-image: url('https://raw.githubusercontent.com/Franknohpoon/puzzle-guardians-backend/main/background.png'); background-size: cover; background-attachment: fixed; background-position: center; background-repeat: no-repeat;">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- í—¤ë” -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4 bg-white bg-opacity-90 backdrop-blur-md p-6 rounded-lg shadow-lg">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2" style="text-shadow: 2px 2px 4px rgba(255,255,255,0.8);">ğŸ® Puzzle&Guardians</h1>
                    <p class="text-gray-800 font-semibold" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">í€˜ìŠ¤íŠ¸ ë³´ìƒ í´ë ˆì„ í˜„í™© ëŒ€ì‹œë³´ë“œ</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearCache()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-semibold">
                        ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ
                    </button>
                    <button onclick="refreshData()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold shadow-lg">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
            <div class="bg-white bg-opacity-95 backdrop-blur-md p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">ë³´ìƒ ì§€ê°‘ ì£¼ì†Œ</p>
                        <a 
                            href="https://kaiascan.io/account/0x3156f02e943cefb0247283b7f89b4ebf91133cff" 
                            target="_blank"
                            class="font-mono text-sm break-all text-purple-600 font-semibold hover:text-purple-800 hover:underline transition-colors">
                            0x3156f02e943cefb0247283b7f89b4ebf91133cff â†—
                        </a>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</p>
                        <p class="text-sm font-semibold text-gray-700" id="lastUpdate">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì „ì²´ í†µê³„ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="stat-card">
                <p class="text-sm opacity-90 mb-1">ğŸ’° ì§€ê°‘ ì”ì•¡</p>
                <p class="text-3xl font-bold" id="totalBalance">ë¡œë”©ì¤‘...</p>
                <p class="text-xs opacity-75 mt-1">BORA</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <p class="text-sm opacity-90 mb-1">âœ… ì´ í´ë ˆì„</p>
                <p class="text-3xl font-bold" id="totalClaims">0</p>
                <p class="text-xs opacity-75 mt-1">ê±´</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <p class="text-sm opacity-90 mb-1">ğŸ‘¥ ì°¸ì—¬ ìœ ì €</p>
                <p class="text-3xl font-bold" id="uniqueUsers">0</p>
                <p class="text-xs opacity-75 mt-1">ëª…</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <p class="text-sm opacity-90 mb-1">ğŸ“ˆ ìœ ì €ë‹¹ í‰ê· </p>
                <p class="text-3xl font-bold" id="avgClaimsPerUser">0</p>
                <p class="text-xs opacity-75 mt-1">í´ë ˆì„/ìœ ì €</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <p class="text-sm opacity-90 mb-1">ğŸ’¸ ì´ ì§€ê¸‰ì•¡</p>
                <p class="text-3xl font-bold" id="totalPaid">0</p>
                <p class="text-xs opacity-75 mt-1">BORA</p>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š ì¼ë³„ í´ë ˆì„ ì¶”ì´</h2>
                <canvas id="dailyClaimsChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ¯ í€˜ìŠ¤íŠ¸ë³„ ë¶„í¬</h2>
                <canvas id="questDistributionChart"></canvas>
            </div>
        </div>

        <!-- ìœ ì € ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ” ìœ ì € ê²€ìƒ‰</h2>
            <div class="flex gap-3 mb-4">
                <input 
                    type="text" 
                    id="userSearchInput" 
                    placeholder="ì§€ê°‘ ì£¼ì†Œ ì…ë ¥ (0x...)" 
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                />
                <button 
                    onclick="searchUser()" 
                    class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                    ê²€ìƒ‰
                </button>
                <button 
                    onclick="clearSearch()" 
                    class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold">
                    ì´ˆê¸°í™”
                </button>
            </div>
            
            <!-- ê²€ìƒ‰ ê²°ê³¼ -->
            <div id="userSearchResult" class="hidden">
                <!-- ìœ ì € ìš”ì•½ -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg mb-4 border border-purple-200">
                    <!-- ì§€ê°‘ ì£¼ì†Œ (ì „ì²´ ë„ˆë¹„) -->
                    <div class="mb-4 pb-3 border-b border-purple-200">
                        <p class="text-xs text-gray-600 mb-1">ì§€ê°‘ ì£¼ì†Œ</p>
                        <div class="flex items-center gap-2">
                            <p class="font-mono text-sm font-bold text-purple-700 break-all" id="searchedAddress">-</p>
                            <button 
                                onclick="copySearchedAddress()" 
                                class="text-gray-400 hover:text-purple-600 transition-colors flex-shrink-0"
                                title="ì£¼ì†Œ ë³µì‚¬">
                                ğŸ“‹
                            </button>
                        </div>
                    </div>
                    
                    <!-- í†µê³„ (3ì»¬ëŸ¼) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-xs text-gray-600 mb-1">ì´ í´ë ˆì„</p>
                            <p class="text-2xl font-bold text-purple-700" id="searchedClaimCount">0</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 mb-1">ì´ ìˆ˜ë ¹ì•¡</p>
                            <p class="text-2xl font-bold text-green-600" id="searchedTotalAmount">0 BORA</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 mb-1">í‰ê·  ê¸ˆì•¡</p>
                            <p class="text-2xl font-bold text-blue-600" id="searchedAvgAmount">0 BORA</p>
                        </div>
                    </div>
                </div>
                
                <!-- í´ë ˆì„ ë‚´ì—­ -->
                <h3 class="font-bold text-gray-800 mb-3">ğŸ“‹ í´ë ˆì„ ë‚´ì—­</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="text-left py-3 px-4 text-gray-700 font-semibold">ë‚ ì§œ</th>
                                <th class="text-left py-3 px-4 text-gray-700 font-semibold">í€˜ìŠ¤íŠ¸</th>
                                <th class="text-right py-3 px-4 text-gray-700 font-semibold">ê¸ˆì•¡</th>
                                <th class="text-left py-3 px-4 text-gray-700 font-semibold">íŠ¸ëœì­ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="searchedTransactions">
                            <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -->
            <div id="userSearchNoResult" class="hidden text-center py-8 text-gray-500">
                <p class="text-lg mb-2">ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <p class="text-sm">í•´ë‹¹ ì§€ê°‘ ì£¼ì†Œì˜ í´ë ˆì„ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- ìœ ì € ë­í‚¹ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- ìµœë‹¤ í´ë ˆì„ ìœ ì € -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ† ìµœë‹¤ í´ë ˆì„ ìœ ì € Top 10</h2>
                <div id="topClaimUsers" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">ë°ì´í„° ë¡œë”©ì¤‘...</p>
                </div>
            </div>
            
            <!-- ìµœë‹¤ ê¸ˆì•¡ ìˆ˜ë ¹ ìœ ì € -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ’° ìµœë‹¤ ê¸ˆì•¡ ìˆ˜ë ¹ ìœ ì € Top 10</h2>
                <div id="topAmountUsers" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">ë°ì´í„° ë¡œë”©ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- í€˜ìŠ¤íŠ¸ë³„ ìƒì„¸ í˜„í™© -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ í€˜ìŠ¤íŠ¸ë³„ ìƒì„¸ í˜„í™©</h2>
                <div class="flex gap-2">
                    <button onclick="downloadQuestStatsCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-sm">
                        ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="downloadQuestStatsJSON()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-sm">
                        ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ
                    </button>
                    <select id="questFilter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="status-active">ì§„í–‰ì¤‘ë§Œ ë³´ê¸°</option>
                        <option value="default">ì „ì²´ ë³´ê¸°</option>
                        <option value="id-asc">í€˜ìŠ¤íŠ¸ ë²ˆí˜¸ìˆœ (ì˜¤ë¦„ì°¨ìˆœ)</option>
                        <option value="id-desc">í€˜ìŠ¤íŠ¸ ë²ˆí˜¸ìˆœ (ë‚´ë¦¼ì°¨ìˆœ)</option>
                        <option value="start-asc">ì‹œì‘ì¼ìˆœ (ë¹ ë¥¸ìˆœ)</option>
                        <option value="start-desc">ì‹œì‘ì¼ìˆœ (ëŠ¦ì€ìˆœ)</option>
                        <option value="reward-asc">ë³´ìƒ ê·œëª¨ìˆœ (ì‘ì€ìˆœ)</option>
                        <option value="reward-desc">ë³´ìƒ ê·œëª¨ìˆœ (í°ìˆœ)</option>
                        <option value="claims-desc">í´ë ˆì„ ë§ì€ìˆœ</option>
                        <option value="claims-asc">í´ë ˆì„ ì ì€ìˆœ</option>
                        <option value="status-ended">ì¢…ë£Œëœ ê²ƒë§Œ ë³´ê¸°</option>
                    </select>
                </div>
            </div>
            <div id="questList" class="space-y-4">
                <div class="text-center py-12">
                    <div class="loading mx-auto"></div>
                    <p class="mt-4 text-gray-600">ë°ì´í„° ë¶„ì„ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- ìµœê·¼ í´ë ˆì„ ë‚´ì—­ -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">ğŸ•’ ìµœê·¼ í´ë ˆì„ ë‚´ì—­</h2>
                <div class="flex gap-2">
                    <select id="transactionQuestFilter" onchange="filterTransactions()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">ì „ì²´ í€˜ìŠ¤íŠ¸</option>
                        <option value="regular">ì¼ë°˜ í€˜ìŠ¤íŠ¸ë§Œ</option>
                        <option value="event">ì´ë²¤íŠ¸ ë¦¬ê·¸ë§Œ</option>
                        <!-- ê°œë³„ í€˜ìŠ¤íŠ¸ëŠ” JSë¡œ ì¶”ê°€ -->
                    </select>
                    <button onclick="downloadTransactionsCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-sm">
                        ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="downloadTransactionsJSON()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-sm">
                        ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50">
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">ì‹œê°„</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">í€˜ìŠ¤íŠ¸</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">ìˆ˜ì‹ ì</th>
                            <th class="text-right py-3 px-4 text-sm font-semibold text-gray-700">ë³´ìƒì•¡</th>
                            <th class="text-center py-3 px-4 text-sm font-semibold text-gray-700">íŠ¸ëœì­ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList">
                        <tr>
                            <td colspan="5" class="text-center py-8">
                                <div class="loading mx-auto"></div>
                                <p class="mt-4 text-gray-600">íŠ¸ëœì­ì…˜ ë¡œë”©ì¤‘...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <button id="prevPage" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors" disabled>â† ì´ì „</button>
                <span class="text-gray-600 font-semibold">í˜ì´ì§€ <span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                <button id="nextPage" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">ë‹¤ìŒ â†’</button>
            </div>
        </div>
    </div>

    <script>
        const WALLET_ADDRESS = '0x3156f02e943cefb0247283b7f89b4ebf91133cff';
        const BORA_TOKEN_ADDRESS = '0x02cbe46fb8a1f579254a9b485788f2d86cad51aa';
        const CACHE_KEY = 'puzzle_guardians_cache';
        const CACHE_DURATION = 5 * 60 * 1000; // 5ë¶„
        
        // Vercel API URL
        const API_URL = 'https://puzzle-guardians-backend-v2.vercel.app/api/transactions';
        
        // í€˜ìŠ¤íŠ¸ ì •ì˜
        const QUESTS = [
            {
                id: 1,
                name: 'ê°€ë””ì–¸ 20ê°œ ìˆ˜ì§‘',
                description: 'ê°€ì… 7ì¼ ì´ë‚´',
                startDate: new Date('2025-10-29'),
                endDate: new Date('2025-11-28'),
                reward: 20,
                token: 'BORA'
            },
            {
                id: 2,
                name: '4ì„± ê°€ë””ì–¸ 3ê°œ ìˆ˜ì§‘',
                description: 'ê°€ì… 7ì¼ ì´ë‚´',
                startDate: new Date('2025-10-29'),
                endDate: new Date('2025-11-28'),
                reward: 40,
                token: 'BORA'
            },
            {
                id: 3,
                name: '50 BOCA íšë“',
                description: 'ê²Œì„ ë‚´ í™”í íšë“',
                startDate: new Date('2025-10-30'),
                endDate: new Date('2025-11-27'),
                reward: 50,
                token: 'BORA'
            },
            {
                id: 4,
                name: '75 BOCA íšë“',
                description: 'ê²Œì„ ë‚´ í™”í íšë“',
                startDate: new Date('2025-10-30'),
                endDate: new Date('2025-11-27'),
                reward: 100,
                token: 'BORA'
            },
            {
                id: 5,
                name: '150 BOCA íšë“',
                description: 'ê²Œì„ ë‚´ í™”í íšë“',
                startDate: new Date('2025-10-30'),
                endDate: new Date('2025-11-27'),
                reward: 270,
                token: 'BORA'
            },
            {
                id: 6,
                name: '300 BOCA íšë“',
                description: 'ê²Œì„ ë‚´ í™”í íšë“',
                startDate: new Date('2025-10-30'),
                endDate: new Date('2025-11-27'),
                reward: 600,
                token: 'BORA'
            },
            {
                id: 10,
                name: 'ë ˆë²¨3+ìŠ¤íƒ€í„°íŒ© êµ¬ë§¤',
                description: 'ì¸ì•± ê²°ì œ',
                startDate: new Date('2026-01-14'),
                endDate: new Date('2026-12-31'),
                reward: 10,
                token: 'BORA'
            },
            // ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨
            {id: 101, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 1ë“±', description: 'ë­í‚¹ 1ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 4350, token: 'BORA', category: 'event'},
            {id: 102, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 2ë“±', description: 'ë­í‚¹ 2ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 2910, token: 'BORA', category: 'event'},
            {id: 103, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 3ë“±', description: 'ë­í‚¹ 3ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 1950, token: 'BORA', category: 'event'},
            {id: 104, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 4~5ìœ„', description: 'ë­í‚¹ 4~5ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 1310, token: 'BORA', category: 'event'},
            {id: 105, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 6~10ìœ„', description: 'ë­í‚¹ 6~10ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 880, token: 'BORA', category: 'event'},
            {id: 106, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 11~20ìœ„', description: 'ë­í‚¹ 11~20ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 590, token: 'BORA', category: 'event'},
            {id: 107, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 21~30ìœ„', description: 'ë­í‚¹ 21~30ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 390, token: 'BORA', category: 'event'},
            {id: 108, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 31~50ìœ„', description: 'ë­í‚¹ 31~50ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 260, token: 'BORA', category: 'event'},
            {id: 109, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 51~70ìœ„', description: 'ë­í‚¹ 51~70ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 180, token: 'BORA', category: 'event'},
            {id: 110, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 71~100ìœ„', description: 'ë­í‚¹ 71~100ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 120, token: 'BORA', category: 'event'},
            {id: 111, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 101~150ìœ„', description: 'ë­í‚¹ 101~150ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 80, token: 'BORA', category: 'event'},
            {id: 112, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 150~200ìœ„', description: 'ë­í‚¹ 150~200ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 50, token: 'BORA', category: 'event'},
            {id: 113, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 201~300ìœ„', description: 'ë­í‚¹ 201~300ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 40, token: 'BORA', category: 'event'},
            {id: 114, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 301~500ìœ„', description: 'ë­í‚¹ 301~500ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 30, token: 'BORA', category: 'event'},
            {id: 115, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 501~750ìœ„', description: 'ë­í‚¹ 501~750ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 20, token: 'BORA', category: 'event'},
            {id: 116, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1íšŒì°¨ - 751~1000ìœ„', description: 'ë­í‚¹ 751~1000ìœ„', startDate: new Date('2025-11-19'), endDate: new Date('2025-11-29'), reward: 10, token: 'BORA', category: 'event'},
            // ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨
            {id: 201, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 1ë“±', description: 'ë­í‚¹ 1ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 1960, token: 'BORA', category: 'event'},
            {id: 202, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 2ë“±', description: 'ë­í‚¹ 2ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 1360, token: 'BORA', category: 'event'},
            {id: 203, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 3ë“±', description: 'ë­í‚¹ 3ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 940, token: 'BORA', category: 'event'},
            {id: 204, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 4~5ìœ„', description: 'ë­í‚¹ 4~5ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 650, token: 'BORA', category: 'event'},
            {id: 205, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 6~10ìœ„', description: 'ë­í‚¹ 6~10ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 450, token: 'BORA', category: 'event'},
            {id: 206, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 11~20ìœ„', description: 'ë­í‚¹ 11~20ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 310, token: 'BORA', category: 'event'},
            {id: 207, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 21~30ìœ„', description: 'ë­í‚¹ 21~30ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 210, token: 'BORA', category: 'event'},
            {id: 208, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 31~50ìœ„', description: 'ë­í‚¹ 31~50ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 150, token: 'BORA', category: 'event'},
            {id: 209, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 51~70ìœ„', description: 'ë­í‚¹ 51~70ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 100, token: 'BORA', category: 'event'},
            {id: 210, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2íšŒì°¨ - 71~100ìœ„', description: 'ë­í‚¹ 71~100ìœ„', startDate: new Date('2025-12-06'), endDate: new Date('2025-12-13'), reward: 70, token: 'BORA', category: 'event'},
            // ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨
            {id: 301, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨ - 1ë“±', description: 'ë­í‚¹ 1ìœ„', startDate: new Date('2025-12-27'), endDate: new Date('2026-01-02'), reward: 10460, token: 'BORA', category: 'event'},
            {id: 302, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨ - 2ë“±', description: 'ë­í‚¹ 2ìœ„', startDate: new Date('2025-12-27'), endDate: new Date('2026-01-02'), reward: 4810, token: 'BORA', category: 'event'},
            {id: 303, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨ - 3ë“±', description: 'ë­í‚¹ 3ìœ„', startDate: new Date('2025-12-27'), endDate: new Date('2026-01-02'), reward: 2210, token: 'BORA', category: 'event'},
            {id: 304, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨ - 4~5ìœ„', description: 'ë­í‚¹ 4~5ìœ„', startDate: new Date('2025-12-27'), endDate: new Date('2026-01-02'), reward: 1020, token: 'BORA', category: 'event'},
            {id: 305, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨ - 6~10ìœ„', description: 'ë­í‚¹ 6~10ìœ„', startDate: new Date('2025-12-27'), endDate: new Date('2026-01-02'), reward: 470, token: 'BORA', category: 'event'},
            {id: 306, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨ - 11~20ìœ„', description: 'ë­í‚¹ 11~20ìœ„', startDate: new Date('2025-12-27'), endDate: new Date('2026-01-02'), reward: 220, token: 'BORA', category: 'event'},
            {id: 307, name: 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3íšŒì°¨ - 21~30ìœ„', description: 'ë­í‚¹ 21~30ìœ„', startDate: new Date('2025-12-27'), endDate: new Date('2026-01-02'), reward: 100, token: 'BORA', category: 'event'}
        ];

        let currentPage = 1;
        let allTransactions = [];
        let filteredTransactions = []; // í•„í„°ë§ëœ íŠ¸ëœì­ì…˜
        let questStatsData = {};
        let dailyClaimsChart, questDistributionChart;

        // ì„œë²„ APIì—ì„œ íŠ¸ëœì­ì…˜ ì¡°íšŒ
        async function fetchTokenTransfersFromAPI() {
            try {
                console.log('ğŸ” ì„œë²„ APIë¡œ íŠ¸ëœì­ì…˜ ì¡°íšŒ ì¤‘...');
                console.log('  API URL:', API_URL);
                
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('ğŸ“¦ API ì‘ë‹µ:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'API ì˜¤ë¥˜');
                }
                
                console.log(`âœ… ${data.count}ê°œ íŠ¸ëœì­ì…˜ ë¡œë“œ ì™„ë£Œ`);
                console.log(`ğŸ’¾ ìºì‹œ ì‚¬ìš©: ${data.cached ? 'Yes' : 'No'}`);
                
                return data.transactions;
                
            } catch (error) {
                console.error('âŒ API ì¡°íšŒ ì‹¤íŒ¨:', error);
                console.log('\nâš ï¸ API URLì„ í™•ì¸í•˜ì„¸ìš”!');
                console.log('í˜„ì¬ ì„¤ì •:', API_URL);
                console.log('Vercel ë°°í¬ í›„ ì‹¤ì œ URLë¡œ ë³€ê²½ í•„ìš”');
                return [];
            }
        }

        // ìºì‹œì—ì„œ ë°ì´í„° ë¡œë“œ
        function loadFromCache() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                const data = JSON.parse(cached);
                const now = Date.now();
                
                // ìºì‹œê°€ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (now - data.timestamp > CACHE_DURATION) {
                    console.log('â° ìºì‹œ ë§Œë£Œë¨');
                    return null;
                }
                
                console.log('âœ… ìºì‹œì—ì„œ ë°ì´í„° ë¡œë“œ:', data.transactions.length, 'ê±´');
                return data;
            } catch (error) {
                console.error('ìºì‹œ ë¡œë“œ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ìºì‹œì— ë°ì´í„° ì €ì¥
        function saveToCache(transactions) {
            try {
                const data = {
                    timestamp: Date.now(),
                    transactions: transactions
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                console.log('ğŸ’¾ ìºì‹œì— ì €ì¥ë¨');
            } catch (error) {
                console.error('ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ìºì‹œ ì‚­ì œ
        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            alert('ìºì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
            location.reload();
        }

        // í€˜ìŠ¤íŠ¸ ì‹ë³„
        function identifyQuest(tx) {
            const amount = Math.round(tx.amount);
            const txDate = new Date(tx.timestamp);
            
            for (let quest of QUESTS) {
                if (amount === quest.reward && 
                    txDate >= quest.startDate && 
                    txDate <= quest.endDate) {
                    return quest;
                }
            }
            return null;
        }

        // í€˜ìŠ¤íŠ¸ ìƒíƒœ í™•ì¸
        function getQuestStatus(quest) {
            const now = new Date();
            if (now < quest.startDate) return 'upcoming';
            if (now > quest.endDate) return 'ended';
            return 'active';
        }

        // ë°ì´í„° ì´ˆê¸°í™”
        async function initializeData() {
            try {
                // ìºì‹œ í™•ì¸
                const cached = loadFromCache();
                
                if (cached) {
                    console.log('ğŸš€ ìºì‹œ ë°ì´í„° ì‚¬ìš©');
                    allTransactions = cached.transactions;
                    updateLastUpdate(new Date(cached.timestamp));
                } else {
                    console.log('ğŸŒ APIì—ì„œ ìƒˆ ë°ì´í„° ë¡œë“œ');
                    const transactions = await fetchTokenTransfersFromAPI();
                    
                    if (transactions.length === 0) {
                        alert('íŠ¸ëœì­ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    allTransactions = transactions;
                    saveToCache(transactions);
                    updateLastUpdate(new Date());
                }
                
                // í€˜ìŠ¤íŠ¸ ì‹ë³„ ë° ê´€ë¦¬ ì¶œê¸ˆ ì œì™¸
                allTransactions = allTransactions
                    .filter(tx => tx.amount !== 400000) // 400,000 BORA ê´€ë¦¬ ì¶œê¸ˆ ì œì™¸
                    .map(tx => ({
                        ...tx,
                        quest: identifyQuest(tx)
                    }))
                    .sort((a, b) => b.timestamp - a.timestamp);

                // BORA ì”ì•¡ ê³„ì‚°
                const totalPaid = allTransactions.reduce((sum, tx) => sum + tx.amount, 0);
                
                // ì´ˆê¸° ì˜ˆì‚° ë° ì”ì•¡ ê³„ì‚°
                // ì´ˆê¸° ì¶©ì „: 762,430 BORA
                // ê´€ë¦¬ ì¶œê¸ˆ: -400,000 BORA (ì§€ê°‘ ê´€ë¦¬ìƒ ì¶œê¸ˆ, í€˜ìŠ¤íŠ¸ ë¬´ê´€)
                // ì¤‘ë³µ ì§€ê¸‰: +1,890 BORA (ì´ë²¤íŠ¸2 ì¤‘ë³µ ì§€ê¸‰)
                // í€˜ìŠ¤íŠ¸ ì§€ê¸‰: -totalPaid
                const INITIAL_DEPOSIT = 762430;
                const MANAGEMENT_WITHDRAWAL = 400000;
                const DUPLICATE_PAYMENT = 1890;
                const currentBalance = INITIAL_DEPOSIT - MANAGEMENT_WITHDRAWAL + DUPLICATE_PAYMENT - totalPaid;
                
                document.getElementById('totalBalance').textContent = currentBalance.toLocaleString(undefined, {maximumFractionDigits: 2});
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalClaims').textContent = allTransactions.length.toLocaleString();
                
                const uniqueUsers = new Set(allTransactions.map(tx => tx.to)).size;
                document.getElementById('uniqueUsers').textContent = uniqueUsers.toLocaleString();
                
                // ìœ ì €ë‹¹ í‰ê·  í´ë ˆì„ íšŸìˆ˜
                const avgClaimsPerUser = uniqueUsers > 0 ? (allTransactions.length / uniqueUsers) : 0;
                document.getElementById('avgClaimsPerUser').textContent = avgClaimsPerUser.toFixed(1);
                
                document.getElementById('totalPaid').textContent = totalPaid.toLocaleString(undefined, {maximumFractionDigits: 2});

                // í€˜ìŠ¤íŠ¸ë³„ ìƒì„¸ í˜„í™©
                updateQuestList();
                
                // ì°¨íŠ¸ ìƒì„±
                createCharts();
                
                // í•„í„° ì´ˆê¸°í™”
                filteredTransactions = [...allTransactions];
                populateQuestFilter();
                
                // íŠ¸ëœì­ì…˜ ëª©ë¡ í‘œì‹œ
                displayTransactions();

            } catch (error) {
                console.error('ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
        function updateLastUpdate(date) {
            document.getElementById('lastUpdate').textContent = date.toLocaleString('ko-KR');
        }

        // í€˜ìŠ¤íŠ¸ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateQuestList() {
            const questStats = {};
            
            QUESTS.forEach(quest => {
                questStats[quest.id] = {
                    quest: quest,
                    claims: 0,
                    users: new Set(),
                    totalPaid: 0,
                    returningUsers: 0, // ê¸°ì¡´ ìœ ì €
                    showReturningRate: false // ì¬ë°©ë¬¸ìœ¨ í‘œì‹œ ì—¬ë¶€
                };
            });
            
            // ëª¨ë“  íŠ¸ëœì­ì…˜ ì²˜ë¦¬
            allTransactions.forEach(tx => {
                if (tx.quest) {
                    const stats = questStats[tx.quest.id];
                    stats.claims++;
                    stats.users.add(tx.to);
                    stats.totalPaid += tx.amount;
                }
            });
            
            // í€˜ìŠ¤íŠ¸ 10 (ë ˆë²¨3+ìŠ¤íƒ€í„°íŒ©): í€˜ìŠ¤íŠ¸ 1~9 ê²½í—˜ì ë¹„ìœ¨
            if (questStats[10]) {
                const quest10Users = questStats[10].users;
                const previousQuestUsers = new Set();
                
                // í€˜ìŠ¤íŠ¸ 1~9ì˜ ëª¨ë“  ìœ ì € ìˆ˜ì§‘
                for (let i = 1; i <= 9; i++) {
                    if (questStats[i]) {
                        questStats[i].users.forEach(user => previousQuestUsers.add(user));
                    }
                }
                
                // í€˜ìŠ¤íŠ¸ 10 ì°¸ì—¬ì ì¤‘ ì´ì „ í€˜ìŠ¤íŠ¸ ê²½í—˜ì ìˆ˜
                let returningCount = 0;
                quest10Users.forEach(user => {
                    if (previousQuestUsers.has(user)) {
                        returningCount++;
                    }
                });
                
                questStats[10].returningUsers = returningCount;
                questStats[10].showReturningRate = true;
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ê·¸ 2: ì´ë²¤íŠ¸ ë¦¬ê·¸ 1 ê²½í—˜ì ë¹„ìœ¨
            const event2Quests = QUESTS.filter(q => q.id >= 201 && q.id < 300);
            if (event2Quests.length > 0) {
                const event1Users = new Set();
                const event2Users = new Set();
                
                // ì´ë²¤íŠ¸ ë¦¬ê·¸ 1 ìœ ì € ìˆ˜ì§‘
                QUESTS.filter(q => q.id >= 101 && q.id < 200).forEach(quest => {
                    if (questStats[quest.id]) {
                        questStats[quest.id].users.forEach(user => event1Users.add(user));
                    }
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ê·¸ 2 ìœ ì € ìˆ˜ì§‘ ë° ì¹´ìš´íŠ¸
                event2Quests.forEach(quest => {
                    if (questStats[quest.id]) {
                        questStats[quest.id].users.forEach(user => event2Users.add(user));
                    }
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ê·¸ 2 ì°¸ì—¬ì ì¤‘ ì´ë²¤íŠ¸ 1 ê²½í—˜ì
                let event2Returning = 0;
                event2Users.forEach(user => {
                    if (event1Users.has(user)) {
                        event2Returning++;
                    }
                });
                
                // ê° í€˜ìŠ¤íŠ¸ì— í†µê³„ ì ìš© (ê·¸ë£¹ ë‹¨ìœ„ë¡œ)
                event2Quests.forEach(quest => {
                    if (questStats[quest.id]) {
                        questStats[quest.id].returningUsers = event2Returning;
                        questStats[quest.id].totalEventUsers = event2Users.size;
                        questStats[quest.id].showReturningRate = true;
                        questStats[quest.id].isEventGroup = true;
                    }
                });
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ê·¸ 3: ì´ë²¤íŠ¸ ë¦¬ê·¸ 1 or 2 ê²½í—˜ì ë¹„ìœ¨
            const event3Quests = QUESTS.filter(q => q.id >= 301 && q.id < 400);
            if (event3Quests.length > 0) {
                const event12Users = new Set();
                const event3Users = new Set();
                
                // ì´ë²¤íŠ¸ ë¦¬ê·¸ 1, 2 ìœ ì € ìˆ˜ì§‘
                QUESTS.filter(q => (q.id >= 101 && q.id < 200) || (q.id >= 201 && q.id < 300)).forEach(quest => {
                    if (questStats[quest.id]) {
                        questStats[quest.id].users.forEach(user => event12Users.add(user));
                    }
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ê·¸ 3 ìœ ì € ìˆ˜ì§‘
                event3Quests.forEach(quest => {
                    if (questStats[quest.id]) {
                        questStats[quest.id].users.forEach(user => event3Users.add(user));
                    }
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ê·¸ 3 ì°¸ì—¬ì ì¤‘ ì´ë²¤íŠ¸ 1,2 ê²½í—˜ì
                let event3Returning = 0;
                event3Users.forEach(user => {
                    if (event12Users.has(user)) {
                        event3Returning++;
                    }
                });
                
                // ê° í€˜ìŠ¤íŠ¸ì— í†µê³„ ì ìš©
                event3Quests.forEach(quest => {
                    if (questStats[quest.id]) {
                        questStats[quest.id].returningUsers = event3Returning;
                        questStats[quest.id].totalEventUsers = event3Users.size;
                        questStats[quest.id].showReturningRate = true;
                        questStats[quest.id].isEventGroup = true;
                    }
                });
            }

            questStatsData = questStats;
            renderQuestList();
            updateUserRankings(); // ìœ ì € ë­í‚¹ ì—…ë°ì´íŠ¸
        }

        // ìœ ì € ë­í‚¹ ì—…ë°ì´íŠ¸
        function updateUserRankings() {
            const userStats = {};
            
            // ìœ ì €ë³„ í†µê³„ ê³„ì‚°
            allTransactions.forEach(tx => {
                if (!userStats[tx.to]) {
                    userStats[tx.to] = {
                        address: tx.to,
                        claimCount: 0,
                        totalAmount: 0,
                        quests: new Set()
                    };
                }
                
                userStats[tx.to].claimCount++;
                userStats[tx.to].totalAmount += tx.amount;
                if (tx.quest) {
                    userStats[tx.to].quests.add(tx.quest.name);
                }
            });
            
            const users = Object.values(userStats);
            
            // ìµœë‹¤ í´ë ˆì„ Top 10
            const topClaimUsers = [...users]
                .sort((a, b) => b.claimCount - a.claimCount)
                .slice(0, 10);
            
            // ìµœë‹¤ ê¸ˆì•¡ Top 10
            const topAmountUsers = [...users]
                .sort((a, b) => b.totalAmount - a.totalAmount)
                .slice(0, 10);
            
            renderTopClaimUsers(topClaimUsers);
            renderTopAmountUsers(topAmountUsers);
        }
        
        // ìµœë‹¤ í´ë ˆì„ ìœ ì € ë Œë”ë§
        function renderTopClaimUsers(users) {
            const html = users.map((user, index) => {
                const shortAddress = user.address.slice(0, 6) + '...' + user.address.slice(-4);
                const avgAmount = user.totalAmount / user.claimCount;
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-bold ${index < 3 ? 'text-2xl' : ''}">${medal}</span>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-mono text-sm font-semibold text-gray-800">${shortAddress}</p>
                                    <button 
                                        onclick="copyAddress('${user.address}')" 
                                        class="text-gray-400 hover:text-purple-600 transition-colors"
                                        title="ì£¼ì†Œ ë³µì‚¬">
                                        ğŸ“‹
                                    </button>
                                    <button 
                                        onclick="searchUserByAddress('${user.address}')" 
                                        class="text-gray-400 hover:text-blue-600 transition-colors"
                                        title="ìƒì„¸ ë³´ê¸°">
                                        ğŸ”
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500">í‰ê·  ${avgAmount.toLocaleString(undefined, {maximumFractionDigits: 1})} BORA</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-purple-600">${user.claimCount}íšŒ</p>
                            <p class="text-xs text-gray-500">${user.totalAmount.toLocaleString()} BORA</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('topClaimUsers').innerHTML = html || '<p class="text-center text-gray-500 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
        
        // ìµœë‹¤ ê¸ˆì•¡ ìˆ˜ë ¹ ìœ ì € ë Œë”ë§
        function renderTopAmountUsers(users) {
            const html = users.map((user, index) => {
                const shortAddress = user.address.slice(0, 6) + '...' + user.address.slice(-4);
                const avgAmount = user.totalAmount / user.claimCount;
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-bold ${index < 3 ? 'text-2xl' : ''}">${medal}</span>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-mono text-sm font-semibold text-gray-800">${shortAddress}</p>
                                    <button 
                                        onclick="copyAddress('${user.address}')" 
                                        class="text-gray-400 hover:text-purple-600 transition-colors"
                                        title="ì£¼ì†Œ ë³µì‚¬">
                                        ğŸ“‹
                                    </button>
                                    <button 
                                        onclick="searchUserByAddress('${user.address}')" 
                                        class="text-gray-400 hover:text-blue-600 transition-colors"
                                        title="ìƒì„¸ ë³´ê¸°">
                                        ğŸ”
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500">${user.claimCount}íšŒ í´ë ˆì„</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-600">${user.totalAmount.toLocaleString()} BORA</p>
                            <p class="text-xs text-gray-500">í‰ê·  ${avgAmount.toLocaleString(undefined, {maximumFractionDigits: 1})}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('topAmountUsers').innerHTML = html || '<p class="text-center text-gray-500 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ìœ ì € ê²€ìƒ‰
        function searchUser() {
            const searchInput = document.getElementById('userSearchInput').value.trim().toLowerCase();
            
            if (!searchInput) {
                alert('ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // í•´ë‹¹ ìœ ì €ì˜ íŠ¸ëœì­ì…˜ í•„í„°ë§
            const userTransactions = allTransactions.filter(tx => 
                tx.to.toLowerCase() === searchInput
            );
            
            if (userTransactions.length === 0) {
                document.getElementById('userSearchResult').classList.add('hidden');
                document.getElementById('userSearchNoResult').classList.remove('hidden');
                return;
            }
            
            // í†µê³„ ê³„ì‚°
            const claimCount = userTransactions.length;
            const totalAmount = userTransactions.reduce((sum, tx) => sum + tx.amount, 0);
            const avgAmount = totalAmount / claimCount;
            
            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            document.getElementById('searchedAddress').textContent = searchInput;
            document.getElementById('searchedClaimCount').textContent = claimCount.toLocaleString() + 'íšŒ';
            document.getElementById('searchedTotalAmount').textContent = totalAmount.toLocaleString(undefined, {maximumFractionDigits: 2}) + ' BORA';
            document.getElementById('searchedAvgAmount').textContent = avgAmount.toLocaleString(undefined, {maximumFractionDigits: 2}) + ' BORA';
            
            // íŠ¸ëœì­ì…˜ ëª©ë¡ í‘œì‹œ (ìµœì‹ ìˆœ)
            const transactionsHtml = userTransactions
                .sort((a, b) => b.timestamp - a.timestamp)
                .map(tx => {
                    const date = new Date(tx.timestamp).toLocaleString('ko-KR');
                    const questName = tx.quest ? tx.quest.name : 'ë¯¸ë¶„ë¥˜';
                    const shortHash = tx.txHash.slice(0, 10) + '...' + tx.txHash.slice(-8);
                    const explorerUrl = `https://kaiascan.io/tx/${tx.txHash}`;
                    
                    return `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-700">${date}</td>
                            <td class="py-3 px-4">
                                <span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-semibold">
                                    ${questName}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-right font-semibold text-green-600">${tx.amount.toLocaleString()} BORA</td>
                            <td class="py-3 px-4">
                                <a href="${explorerUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 font-mono text-xs">
                                    ${shortHash} â†—
                                </a>
                            </td>
                        </tr>
                    `;
                }).join('');
            
            document.getElementById('searchedTransactions').innerHTML = transactionsHtml;
            document.getElementById('userSearchResult').classList.remove('hidden');
            document.getElementById('userSearchNoResult').classList.add('hidden');
            
            // ê²€ìƒ‰ ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('userSearchResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // ê²€ìƒ‰ ì´ˆê¸°í™”
        function clearSearch() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResult').classList.add('hidden');
            document.getElementById('userSearchNoResult').classList.add('hidden');
        }
        
        // ì£¼ì†Œ ë³µì‚¬
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                // ë³µì‚¬ ì„±ê³µ ì•Œë¦¼
                const notification = document.createElement('div');
                notification.textContent = 'âœ… ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 2000);
            }).catch(err => {
                alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
            });
        }
        
        // ê²€ìƒ‰ëœ ì£¼ì†Œ ë³µì‚¬
        function copySearchedAddress() {
            const address = document.getElementById('searchedAddress').textContent;
            copyAddress(address);
        }
        
        // ì´ë²¤íŠ¸ ìƒì„¸ í† ê¸€
        function toggleEventDetail(round) {
            const detailElement = document.getElementById(`event-detail-${round}`);
            const arrowElement = document.getElementById(`event-arrow-${round}`);
            
            if (detailElement.classList.contains('hidden')) {
                // í¼ì¹˜ê¸°
                detailElement.classList.remove('hidden');
                arrowElement.style.transform = 'rotate(90deg)';
            } else {
                // ì ‘ê¸°
                detailElement.classList.add('hidden');
                arrowElement.style.transform = 'rotate(0deg)';
            }
        }
        
        // ìœ ì € ìƒì„¸ë³´ê¸° (ì£¼ì†Œë¡œ ìë™ ê²€ìƒ‰)
        function searchUserByAddress(address) {
            document.getElementById('userSearchInput').value = address;
            searchUser();
        }
        
        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('userSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUser();
                    }
                });
            }
        });

        // í€˜ìŠ¤íŠ¸ ëª©ë¡ ë Œë”ë§ (ê·¸ë£¹í™”)
        function renderQuestList() {
            const filterValue = document.getElementById('questFilter')?.value || 'status-active';
            
            // í€˜ìŠ¤íŠ¸ì™€ ì´ë²¤íŠ¸ ë¶„ë¦¬
            let regularQuests = QUESTS.filter(q => !q.category).map(quest => ({
                quest: quest,
                stats: questStatsData[quest.id],
                status: getQuestStatus(quest)
            }));
            
            // í•„í„° ì ìš© (ì¼ë°˜ í€˜ìŠ¤íŠ¸ë§Œ)
            if (filterValue === 'status-active') {
                regularQuests = regularQuests.filter(q => q.status === 'active');
            } else if (filterValue === 'status-ended') {
                regularQuests = regularQuests.filter(q => q.status === 'ended');
            } else if (filterValue === 'status-upcoming') {
                regularQuests = regularQuests.filter(q => q.status === 'upcoming');
            }
            
            // ì •ë ¬ ì ìš©
            switch(filterValue) {
                case 'id-asc':
                    regularQuests.sort((a, b) => a.quest.id - b.quest.id);
                    break;
                case 'id-desc':
                    regularQuests.sort((a, b) => b.quest.id - a.quest.id);
                    break;
                case 'start-asc':
                    regularQuests.sort((a, b) => a.quest.startDate - b.quest.startDate);
                    break;
                case 'start-desc':
                    regularQuests.sort((a, b) => b.quest.startDate - a.quest.startDate);
                    break;
                case 'reward-asc':
                    regularQuests.sort((a, b) => a.quest.reward - b.quest.reward);
                    break;
                case 'reward-desc':
                    regularQuests.sort((a, b) => b.quest.reward - a.quest.reward);
                    break;
                case 'claims-desc':
                    regularQuests.sort((a, b) => b.stats.claims - a.stats.claims);
                    break;
                case 'claims-asc':
                    regularQuests.sort((a, b) => a.stats.claims - b.stats.claims);
                    break;
            }
            
            // ì´ë²¤íŠ¸ë¥¼ íšŒì°¨ë³„ë¡œ ê·¸ë£¹í™”
            const events = {
                1: QUESTS.filter(q => q.category === 'event' && q.id >= 101 && q.id < 200),
                2: QUESTS.filter(q => q.category === 'event' && q.id >= 201 && q.id < 300),
                3: QUESTS.filter(q => q.category === 'event' && q.id >= 301 && q.id < 400)
            };

            let html = '';

            // ì¼ë°˜ í€˜ìŠ¤íŠ¸ ë Œë”ë§
            html += '<h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“Š ì¼ë°˜ í€˜ìŠ¤íŠ¸</h2>';
            
            if (regularQuests.length === 0) {
                html += '<p class="text-center text-gray-500 py-8 mb-8">í•´ë‹¹ ì¡°ê±´ì˜ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                regularQuests.forEach(({quest, stats, status}) => {
                const statusText = status === 'active' ? 'ì§„í–‰ì¤‘' : status === 'ended' ? 'ì¢…ë£Œ' : 'ì˜ˆì •';
                const statusClass = status === 'active' ? 'bg-green-500' : status === 'ended' ? 'bg-red-500' : 'bg-orange-500';
                const cardClass = status === 'active' ? 'quest-active' : status === 'ended' ? 'quest-ended' : 'quest-upcoming';
                
                const progress = stats.claims > 0 ? Math.min(100, (stats.claims / 100) * 100) : 0;
                const avgClaimsPerUser = stats.users.size > 0 ? (stats.claims / stats.users.size) : 0;
                
                // ì¬ë°©ë¬¸ìœ¨ ê³„ì‚° (í‘œì‹œí•´ì•¼ í•˜ëŠ” ê²½ìš°ë§Œ)
                let returningRate = 0;
                let returningRateHtml = '';
                if (stats.showReturningRate) {
                    const totalUsers = stats.isEventGroup ? stats.totalEventUsers : stats.users.size;
                    returningRate = totalUsers > 0 ? (stats.returningUsers / totalUsers * 100) : 0;
                    const newUsers = totalUsers - stats.returningUsers;
                    
                    let tooltip = '';
                    if (quest.id === 10) {
                        tooltip = `ì´ì „ í€˜ìŠ¤íŠ¸(1-9) ê²½í—˜ì: ${stats.returningUsers}ëª… / ì‹ ê·œ: ${newUsers}ëª…`;
                    } else if (stats.isEventGroup && quest.id >= 201 && quest.id < 300) {
                        tooltip = `ì´ë²¤íŠ¸ ë¦¬ê·¸ 1 ê²½í—˜ì: ${stats.returningUsers}ëª… / ì‹ ê·œ: ${newUsers}ëª…`;
                    } else if (stats.isEventGroup && quest.id >= 301) {
                        tooltip = `ì´ë²¤íŠ¸ ë¦¬ê·¸ 1,2 ê²½í—˜ì: ${stats.returningUsers}ëª… / ì‹ ê·œ: ${newUsers}ëª…`;
                    }
                    
                    returningRateHtml = `<p class="text-xs ${returningRate >= 50 ? 'text-green-600' : 'text-orange-600'} font-semibold" title="${tooltip}">
                        ğŸ”„ ê¸°ì¡´ ìœ ì €: ${returningRate.toFixed(1)}%
                    </p>`;
                }

                html += `
                    <div class="quest-card ${cardClass} mb-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-bold text-lg text-gray-800">í€˜ìŠ¤íŠ¸ ${quest.id}: ${quest.name}</h3>
                                    <span class="status-badge ${statusClass} text-white">${statusText}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${quest.description}</p>
                                <p class="text-xs text-gray-500">
                                    ğŸ“… ${quest.startDate.toLocaleDateString('ko-KR')} ~ ${quest.endDate.toLocaleDateString('ko-KR')}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-purple-600">${quest.reward} ${quest.token}</p>
                                <p class="text-xs text-gray-500">ë³´ìƒ</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-4 mb-3">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">í´ë ˆì„ ìˆ˜</p>
                                <p class="text-xl font-bold text-gray-800">${stats.claims.toLocaleString()}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">ì°¸ì—¬ ìœ ì €</p>
                                <p class="text-xl font-bold text-gray-800">${stats.users.size.toLocaleString()}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">ìœ ì €ë‹¹ í‰ê· </p>
                                <p class="text-xl font-bold text-blue-600">${(stats.claims / stats.users.size).toFixed(1)}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">ì´ ì§€ê¸‰ì•¡</p>
                                <p class="text-xl font-bold text-gray-800">${stats.totalPaid.toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center gap-4">
                                <p class="text-xs text-gray-500">í™œë™ë¥ : ${progress.toFixed(1)}%</p>
                                ${returningRateHtml}
                            </div>
                            <div class="flex gap-1">
                                <button onclick="downloadQuestDataCSV(${quest.id})" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors" title="CSV ë‹¤ìš´ë¡œë“œ">
                                    ğŸ“¥ CSV
                                </button>
                                <button onclick="downloadQuestDataJSON(${quest.id})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 transition-colors" title="JSON ë‹¤ìš´ë¡œë“œ">
                                    ğŸ“¥ JSON
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            }

            // ì´ë²¤íŠ¸ ë¦¬ê·¸ ë Œë”ë§
            html += '<h2 class="text-2xl font-bold mb-4 mt-8 text-gray-800">ğŸ† ì´ë²¤íŠ¸ ë¦¬ê·¸</h2>';
            
            [1, 2, 3].forEach(round => {
                const eventQuests = events[round];
                if (eventQuests.length === 0) return;

                // ì´ë²¤íŠ¸ ì „ì²´ í†µê³„ ê³„ì‚°
                let totalClaims = 0;
                let totalUsers = new Set();
                let totalPaid = 0;
                
                eventQuests.forEach(q => {
                    const stats = questStatsData[q.id];
                    totalClaims += stats.claims;
                    stats.users.forEach(u => totalUsers.add(u));
                    totalPaid += stats.totalPaid;
                });

                const firstQuest = eventQuests[0];
                const status = getQuestStatus(firstQuest);
                const statusText = status === 'active' ? 'ì§„í–‰ì¤‘' : status === 'ended' ? 'ì¢…ë£Œ' : 'ì˜ˆì •';
                const statusClass = status === 'active' ? 'bg-green-500' : status === 'ended' ? 'bg-red-500' : 'bg-orange-500';
                const cardClass = status === 'active' ? 'quest-active' : status === 'ended' ? 'quest-ended' : 'quest-upcoming';

                html += `
                    <div class="quest-card ${cardClass} mb-6">
                        <!-- í—¤ë” (í•­ìƒ í‘œì‹œ, í´ë¦­ ê°€ëŠ¥) -->
                        <div 
                            onclick="toggleEventDetail(${round})" 
                            class="cursor-pointer hover:bg-gray-50 p-4 rounded-lg transition-colors -m-4 mb-4"
                        >
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span id="event-arrow-${round}" class="text-gray-500 transition-transform">â–¶</span>
                                        <h3 class="font-bold text-xl text-gray-800">ğŸ† ì´ë²¤íŠ¸ ë¦¬ê·¸ ${round}íšŒì°¨</h3>
                                        <span class="status-badge ${statusClass} text-white">${statusText}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 ml-6">
                                        ğŸ“… ${firstQuest.startDate.toLocaleDateString('ko-KR')} ~ ${firstQuest.endDate.toLocaleDateString('ko-KR')}
                                    </p>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-4 mt-4">
                                <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                    <p class="text-xs text-purple-600 mb-1 font-semibold">ì´ í´ë ˆì„</p>
                                    <p class="text-2xl font-bold text-purple-700">${totalClaims.toLocaleString()}</p>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                    <p class="text-xs text-purple-600 mb-1 font-semibold">ì°¸ì—¬ ìœ ì €</p>
                                    <p class="text-2xl font-bold text-purple-700">${totalUsers.size.toLocaleString()}</p>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                    <p class="text-xs text-purple-600 mb-1 font-semibold">ì´ ì§€ê¸‰ì•¡</p>
                                    <p class="text-2xl font-bold text-purple-700">${totalPaid.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ìƒì„¸ ë‚´ì—­ (ì ‘íŒ ìƒíƒœ) -->
                        <div id="event-detail-${round}" class="hidden mt-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-sm text-gray-700 mb-3">ë“±ìˆ˜ë³„ ìƒì„¸ ë‚´ì—­</h4>
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-300">
                                            <th class="text-left py-2 text-gray-600">ë“±ìˆ˜</th>
                                            <th class="text-right py-2 text-gray-600">ë³´ìƒ</th>
                                            <th class="text-right py-2 text-gray-600">í´ë ˆì„ ìˆ˜</th>
                                            <th class="text-right py-2 text-gray-600">ì§€ê¸‰ì•¡</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;

                eventQuests.forEach(q => {
                    const stats = questStatsData[q.id];
                    const rank = q.description.replace('ë­í‚¹ ', '');
                    html += `
                        <tr class="border-b border-gray-200 hover:bg-white">
                            <td class="py-2 text-gray-800">${rank}</td>
                            <td class="text-right py-2 font-semibold text-purple-600">${q.reward.toLocaleString()} BORA</td>
                            <td class="text-right py-2 text-gray-700">${stats.claims.toLocaleString()}íšŒ</td>
                            <td class="text-right py-2 text-gray-700">${stats.totalPaid.toLocaleString()} BORA</td>
                        </tr>
                    `;
                });

                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('questList').innerHTML = html || '<p class="text-center text-gray-500 py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ì°¨íŠ¸ ìƒì„±
        function createCharts() {
            const dailyData = {};
            allTransactions.forEach(tx => {
                const date = new Date(tx.timestamp).toLocaleDateString('ko-KR');
                dailyData[date] = (dailyData[date] || 0) + 1;
            });

            const ctx1 = document.getElementById('dailyClaimsChart').getContext('2d');
            if (dailyClaimsChart) dailyClaimsChart.destroy();
            dailyClaimsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Object.keys(dailyData).reverse().slice(0, 30),
                    datasets: [{
                        label: 'í´ë ˆì„ ìˆ˜',
                        data: Object.values(dailyData).reverse().slice(0, 30),
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            const questDistribution = {};
            allTransactions.forEach(tx => {
                if (tx.quest) {
                    let questLabel;
                    
                    // ì´ë²¤íŠ¸ ë¦¬ê·¸ëŠ” í•˜ë‚˜ë¡œ ê·¸ë£¹í™”
                    if (tx.quest.category === 'event') {
                        if (tx.quest.id >= 101 && tx.quest.id < 200) {
                            questLabel = 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 1';
                        } else if (tx.quest.id >= 201 && tx.quest.id < 300) {
                            questLabel = 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 2';
                        } else if (tx.quest.id >= 301 && tx.quest.id < 400) {
                            questLabel = 'ì´ë²¤íŠ¸ ë¦¬ê·¸ 3';
                        } else {
                            questLabel = tx.quest.name;
                        }
                    } else {
                        // ì¼ë°˜ í€˜ìŠ¤íŠ¸ëŠ” ì´ë¦„ ì‚¬ìš©
                        questLabel = tx.quest.name;
                        // ì´ë¦„ì´ ë„ˆë¬´ ê¸¸ë©´ ì¤„ì„
                        if (questLabel.length > 20) {
                            questLabel = questLabel.substring(0, 20) + '...';
                        }
                    }
                    
                    questDistribution[questLabel] = (questDistribution[questLabel] || 0) + 1;
                }
            });

            const ctx2 = document.getElementById('questDistributionChart').getContext('2d');
            if (questDistributionChart) questDistributionChart.destroy();
            questDistributionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(questDistribution),
                    datasets: [{
                        data: Object.values(questDistribution),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(240, 147, 251, 0.8)',
                            'rgba(79, 172, 254, 0.8)',
                            'rgba(67, 233, 123, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(250, 204, 21, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                boxWidth: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            return {
                                                text: `${label} (${value})`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}íšŒ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // íŠ¸ëœì­ì…˜ ëª©ë¡ í‘œì‹œ
        function displayTransactions() {
            const itemsPerPage = 20;
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(start, end);

            if (pageTransactions.length === 0) {
                document.getElementById('transactionList').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            íŠ¸ëœì­ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                document.getElementById('currentPage').textContent = '0';
                document.getElementById('totalPages').textContent = '0';
                return;
            }

            const html = pageTransactions.map(tx => {
                const date = new Date(tx.timestamp);
                return `
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 text-sm text-gray-600">
                            ${date.toLocaleString('ko-KR')}
                        </td>
                        <td class="py-3 px-4 text-sm">
                            <span class="font-semibold text-purple-600">Q${tx.quest?.id || '?'}</span>
                            <span class="text-gray-600 text-xs block">${tx.quest?.name || 'ë¯¸ë¶„ë¥˜'}</span>
                        </td>
                        <td class="py-3 px-4 text-sm font-mono text-gray-700">
                            ${tx.to.substr(0, 6)}...${tx.to.substr(-4)}
                        </td>
                        <td class="py-3 px-4 text-sm text-right">
                            <span class="font-bold text-green-600">${tx.amount.toFixed(2)} ${tx.token}</span>
                        </td>
                        <td class="py-3 px-4 text-sm text-center">
                            <a href="https://kaiascan.io/tx/${tx.txHash}" target="_blank" 
                               class="text-blue-600 hover:text-blue-800 hover:underline text-xs">
                                ë³´ê¸° â†’
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('transactionList').innerHTML = html;
            document.getElementById('currentPage').textContent = currentPage;
            const totalPages = Math.ceil(filteredTransactions.length / 20);
            document.getElementById('totalPages').textContent = totalPages || 1;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = end >= filteredTransactions.length;
        }

        // íŠ¸ëœì­ì…˜ í•„í„°ë§
        function filterTransactions() {
            const filterValue = document.getElementById('transactionQuestFilter').value;
            
            if (filterValue === 'all') {
                filteredTransactions = [...allTransactions];
            } else if (filterValue === 'regular') {
                filteredTransactions = allTransactions.filter(tx => 
                    tx.quest && !tx.quest.category
                );
            } else if (filterValue === 'event') {
                filteredTransactions = allTransactions.filter(tx => 
                    tx.quest && tx.quest.category === 'event'
                );
            } else if (filterValue.startsWith('event-')) {
                // ì´ë²¤íŠ¸ ë¦¬ê·¸ë³„ í•„í„°
                const eventRound = parseInt(filterValue.split('-')[1]);
                filteredTransactions = allTransactions.filter(tx => {
                    if (!tx.quest || tx.quest.category !== 'event') return false;
                    if (eventRound === 1) return tx.quest.id >= 101 && tx.quest.id < 200;
                    if (eventRound === 2) return tx.quest.id >= 201 && tx.quest.id < 300;
                    if (eventRound === 3) return tx.quest.id >= 301 && tx.quest.id < 400;
                    return false;
                });
            } else {
                // ê°œë³„ í€˜ìŠ¤íŠ¸ í•„í„°
                const questId = parseInt(filterValue);
                filteredTransactions = allTransactions.filter(tx => 
                    tx.quest && tx.quest.id === questId
                );
            }
            
            currentPage = 1;
            displayTransactions();
        }

        // í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
        function populateQuestFilter() {
            const select = document.getElementById('transactionQuestFilter');
            
            // ì´ë²¤íŠ¸ ë¦¬ê·¸ ì˜µì…˜ ì¶”ê°€
            const eventOption1 = document.createElement('optgroup');
            eventOption1.label = 'ì´ë²¤íŠ¸ ë¦¬ê·¸';
            eventOption1.innerHTML = `
                <option value="event-1">ì´ë²¤íŠ¸ ë¦¬ê·¸ 1</option>
                <option value="event-2">ì´ë²¤íŠ¸ ë¦¬ê·¸ 2</option>
                <option value="event-3">ì´ë²¤íŠ¸ ë¦¬ê·¸ 3</option>
            `;
            select.appendChild(eventOption1);
            
            // ì¼ë°˜ í€˜ìŠ¤íŠ¸ ì˜µì…˜ ì¶”ê°€
            const regularQuests = QUESTS.filter(q => !q.category);
            if (regularQuests.length > 0) {
                const regularGroup = document.createElement('optgroup');
                regularGroup.label = 'ì¼ë°˜ í€˜ìŠ¤íŠ¸';
                regularQuests.forEach(quest => {
                    const option = document.createElement('option');
                    option.value = quest.id;
                    option.textContent = `Q${quest.id}: ${quest.name}`;
                    regularGroup.appendChild(option);
                });
                select.appendChild(regularGroup);
            }
        }

        // í˜ì´ì§€ë„¤ì´ì…˜
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayTransactions();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage * 20 < filteredTransactions.length) {
                currentPage++;
                displayTransactions();
            }
        });

        // ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
        async function refreshData() {
            localStorage.removeItem(CACHE_KEY);
            currentPage = 1;
            await initializeData();
        }

        // CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadCSV(data, filename) {
            const csv = data.join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // JSON ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // íŠ¸ëœì­ì…˜ CSV ë‹¤ìš´ë¡œë“œ
        function downloadTransactionsCSV() {
            const headers = ['ë‚ ì§œ', 'ì‹œê°„', 'í€˜ìŠ¤íŠ¸ ID', 'í€˜ìŠ¤íŠ¸ëª…', 'ìˆ˜ì‹ ì ì£¼ì†Œ', 'ë³´ìƒì•¡ (BORA)', 'íŠ¸ëœì­ì…˜ í•´ì‹œ', 'ë¸”ë¡ ë²ˆí˜¸'];
            const rows = [headers.join(',')];
            
            allTransactions.forEach(tx => {
                const date = new Date(tx.timestamp);
                const dateStr = date.toLocaleDateString('ko-KR');
                const timeStr = date.toLocaleTimeString('ko-KR');
                const questId = tx.quest ? tx.quest.id : 'ë¯¸ë¶„ë¥˜';
                const questName = tx.quest ? tx.quest.name : 'ë¯¸ë¶„ë¥˜';
                const row = [
                    dateStr,
                    timeStr,
                    questId,
                    `"${questName}"`,
                    tx.to,
                    tx.amount,
                    tx.txHash,
                    tx.blockNumber
                ].join(',');
                rows.push(row);
            });
            
            const timestamp = new Date().toISOString().split('T')[0];
            downloadCSV(rows, `puzzle-guardians-transactions-${timestamp}.csv`);
        }

        // íŠ¸ëœì­ì…˜ JSON ë‹¤ìš´ë¡œë“œ
        function downloadTransactionsJSON() {
            const data = allTransactions.map(tx => ({
                date: new Date(tx.timestamp).toISOString(),
                questId: tx.quest ? tx.quest.id : null,
                questName: tx.quest ? tx.quest.name : 'ë¯¸ë¶„ë¥˜',
                toAddress: tx.to,
                amount: tx.amount,
                token: tx.token,
                txHash: tx.txHash,
                blockNumber: tx.blockNumber
            }));
            
            const timestamp = new Date().toISOString().split('T')[0];
            downloadJSON(data, `puzzle-guardians-transactions-${timestamp}.json`);
        }

        // í€˜ìŠ¤íŠ¸ í†µê³„ CSV ë‹¤ìš´ë¡œë“œ
        function downloadQuestStatsCSV() {
            const headers = ['í€˜ìŠ¤íŠ¸ ID', 'í€˜ìŠ¤íŠ¸ëª…', 'ì„¤ëª…', 'ë³´ìƒì•¡ (BORA)', 'ì‹œì‘ì¼', 'ì¢…ë£Œì¼', 'ìƒíƒœ', 'í´ë ˆì„ ìˆ˜', 'ì°¸ì—¬ ìœ ì € ìˆ˜', 'ì´ ì§€ê¸‰ì•¡ (BORA)'];
            const rows = [headers.join(',')];
            
            QUESTS.forEach(quest => {
                const stats = questStatsData[quest.id];
                const status = getQuestStatus(quest);
                const statusText = status === 'active' ? 'ì§„í–‰ì¤‘' : status === 'ended' ? 'ì¢…ë£Œ' : 'ì˜ˆì •';
                
                const row = [
                    quest.id,
                    `"${quest.name}"`,
                    `"${quest.description}"`,
                    quest.reward,
                    quest.startDate.toLocaleDateString('ko-KR'),
                    quest.endDate.toLocaleDateString('ko-KR'),
                    statusText,
                    stats.claims,
                    stats.users.size,
                    stats.totalPaid
                ].join(',');
                rows.push(row);
            });
            
            const timestamp = new Date().toISOString().split('T')[0];
            downloadCSV(rows, `puzzle-guardians-quest-stats-${timestamp}.csv`);
        }

        // í€˜ìŠ¤íŠ¸ í†µê³„ JSON ë‹¤ìš´ë¡œë“œ
        function downloadQuestStatsJSON() {
            const data = QUESTS.map(quest => {
                const stats = questStatsData[quest.id];
                const status = getQuestStatus(quest);
                return {
                    questId: quest.id,
                    questName: quest.name,
                    description: quest.description,
                    reward: quest.reward,
                    token: quest.token,
                    startDate: quest.startDate.toISOString(),
                    endDate: quest.endDate.toISOString(),
                    status: status,
                    claimCount: stats.claims,
                    uniqueUsers: stats.users.size,
                    totalPaid: stats.totalPaid,
                    category: quest.category || 'regular'
                };
            });
            
            const timestamp = new Date().toISOString().split('T')[0];
            downloadJSON(data, `puzzle-guardians-quest-stats-${timestamp}.json`);
        }

        // ê°œë³„ í€˜ìŠ¤íŠ¸ CSV ë‹¤ìš´ë¡œë“œ
        function downloadQuestDataCSV(questId) {
            const quest = QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            const questTransactions = allTransactions.filter(tx => tx.quest && tx.quest.id === questId);
            
            const headers = ['ë‚ ì§œ', 'ì‹œê°„', 'ìˆ˜ì‹ ì ì£¼ì†Œ', 'ë³´ìƒì•¡ (BORA)', 'íŠ¸ëœì­ì…˜ í•´ì‹œ', 'ë¸”ë¡ ë²ˆí˜¸'];
            const rows = [headers.join(',')];
            
            questTransactions.forEach(tx => {
                const date = new Date(tx.timestamp);
                const dateStr = date.toLocaleDateString('ko-KR');
                const timeStr = date.toLocaleTimeString('ko-KR');
                const row = [
                    dateStr,
                    timeStr,
                    tx.to,
                    tx.amount,
                    tx.txHash,
                    tx.blockNumber
                ].join(',');
                rows.push(row);
            });
            
            const timestamp = new Date().toISOString().split('T')[0];
            const questName = quest.name.replace(/[^\wê°€-í£]/g, '-');
            downloadCSV(rows, `quest-${questId}-${questName}-${timestamp}.csv`);
        }

        // ê°œë³„ í€˜ìŠ¤íŠ¸ JSON ë‹¤ìš´ë¡œë“œ
        function downloadQuestDataJSON(questId) {
            const quest = QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            const questTransactions = allTransactions.filter(tx => tx.quest && tx.quest.id === questId);
            const stats = questStatsData[questId];
            
            const data = {
                quest: {
                    id: quest.id,
                    name: quest.name,
                    description: quest.description,
                    reward: quest.reward,
                    token: quest.token,
                    startDate: quest.startDate.toISOString(),
                    endDate: quest.endDate.toISOString(),
                    status: getQuestStatus(quest),
                    category: quest.category || 'regular'
                },
                statistics: {
                    totalClaims: stats.claims,
                    uniqueUsers: stats.users.size,
                    totalPaid: stats.totalPaid
                },
                transactions: questTransactions.map(tx => ({
                    date: new Date(tx.timestamp).toISOString(),
                    toAddress: tx.to,
                    amount: tx.amount,
                    token: tx.token,
                    txHash: tx.txHash,
                    blockNumber: tx.blockNumber
                }))
            };
            
            const timestamp = new Date().toISOString().split('T')[0];
            const questName = quest.name.replace(/[^\wê°€-í£]/g, '-');
            downloadJSON(data, `quest-${questId}-${questName}-${timestamp}.json`);
        }

        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            initializeData();
            
            const filterSelect = document.getElementById('questFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', renderQuestList);
            }
        });
    </script>
</body>
</html>
